apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-smoke-test
spec:
  backoffLimit: 0   # donâ€™t retry forever
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: kafka-smoke-test
          image: bitnami/kafka:latest
          command:
            - bash
            - -c
            - |
              echo "ðŸ‘‰ Creating test topic..."
              kafka-topics.sh --create --if-not-exists \
                --topic smoke-test \
                --bootstrap-server kafka:9092 \
                --partitions 1 --replication-factor 1

              echo "ðŸ‘‰ Producing message..."
              echo "hello-kafka" | kafka-console-producer.sh \
                --topic smoke-test \
                --bootstrap-server kafka:9092 \
                --producer-property acks=all

              echo "ðŸ‘‰ Waiting for message to flush..."
              sleep 5

              echo "ðŸ‘‰ Consuming message..."
              kafka-console-consumer.sh \
                --topic smoke-test \
                --from-beginning \
                --bootstrap-server kafka:9092 \
                --timeout-ms 20000 \
                --max-messages 1 \
                --group smoke-test-consumer
